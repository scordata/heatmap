var $loading=$("#loading"),$table,mapdiv=document.getElementById("map");fshm=new Object;fshm.map={};fshm.venueList=[];fshm.infoWindow=new google.maps.InfoWindow;fshm.radius=4828;fshm.currentPosition={};fshm.zoom=15;fshm.category="";fshm.locationPageSuccess=function(e){"use strict";var t=40.743648;var n=-73.989193;fshm.currentPosition.lat=t;fshm.currentPosition.lng=n;fshm.foursquareQuery(t,n,fshm.radius)};fshm.foursquareQuery=function(e,t){"use strict";var n=$("#results");$loading.fadeIn(3500);$.ajax({url:"https://api.foursquare.com/v2/venues/search",dataType:"json",data:{client_id:"N50XZT0AJ50Z5P4S2WOZDQ1C50F4UILQR5MB0ETZ4ZAX5PQ2",client_secret:"1LCYL00AHF45TS5LUPTBQCNR4UHNHS2GNOSUOSZ4EA0AGAT1",intent:"browse",radius:this.radius,ll:e+","+t,categoryId:this.category,v:"20130105"},success:function(n){var r=$("tbody");$table=$("table");r.children().remove();fshm.venueList=n.response.venues.sort(function(e,t){if(e.hereNow.count<t.hereNow.count){return 1}else if(e.hereNow.count>t.hereNow.count){return-1}else{return 0}});fshm.initGMap(fshm.venueList,e,t);$table.trigger("update")},error:function(e){console.log(e.responseText)}})};fshm.initGMap=function(e,t,n){delete map;var r=new google.maps.LatLng(t,n),i={zoom:this.zoom,center:r,draggable:true,mapTypeId:google.maps.MapTypeId.ROADMAP,mapTypeControl:false,panControl:false,streetViewControl:false,zoomControl:false,scaleControl:false,keyboardShortcuts:false,scrollwheel:false,mapTypeControlOptions:{mapTypeIDs:[google.maps.MapTypeId.ROADMAP,"_map_style"]}};this.map=new google.maps.Map(mapdiv,i);$(mapdiv).append("<div id='loading'>Live Section Loading...</div>");for(var s=0;s<e.length;s++){var o=new google.maps.LatLng(e[s].location.lat,e[s].location.lng),u={strokeColor:"#009600",strokeOpacity:.75,strokeWeight:1.5,fillColor:"#009600",fillOpacity:.5,map:this.map,center:o,radius:e[s].hereNow.count*5,clickable:true,html:fshm.venueInfoOutput(e[s])},a;if(e[s].hereNow.count>100){u.strokeColor="#f00";u.fillColor="#f00";u.fillOpacity=.25}else if(e[s].hereNow.count>50){u.strokeColor="#ffef00";u.fillColor="#ffef00";u.fillOpacity=.4}else if(e[s].hereNow.count>25){u.strokeColor="#009600";u.fillColor="#009600";u.fillOpacity=.55}else if(e[s].hereNow.count>10){u.strokeColor="#a3a3a3";u.fillColor="#a3a3a3";u.fillOpacity=.65}else{u.radius=e[s].hereNow.count*10}a=new google.maps.Circle(u);google.maps.event.addListener(a,"click",this.showInfo)}this.map.setCenter(r);$loading=$("#loading");$loading.fadeOut(1)};fshm.showInfo=function(e){fshm.infoWindow.setContent(this.html);fshm.infoWindow.setPosition(this.center);fshm.infoWindow.open(fshm.map)};fshm.venueInfoOutput=function(e){var t=e.categories[0].pluralName?e.categories[0].pluralName:e.categories[0].name;$.ajax({type:"POST",url:"locsaver.php",data:{name:e.name,location:e.location.address,herenow:e.hereNow.count}});return e.name+"<br />"+e.location.address+"<br />People Here: "+e.hereNow.count+"<br><a target='_blank' href='"+e.canonicalUrl+"'>FourSquare</a>"};$(function(){"use strict";var e=$("#search"),t=$("#distance"),n=$('input[type="radio"]'),r=$("table"),i=decodeURIComponent(window.location.search.replace(/\+/g,"%20")),s,o,u,a,f,l;i=i.substr(1);if(i.indexOf("loc=")!==-1||i.indexOf("q=")!==-1){s=i.split("&");$.each(s,function(){f=this.split("=");l=f[0];f=f[1];if(l==="loc"||l==="q"){a=f}else if(l==="r"||l==="radius"){fshm.radius=f}});e.val(a);fshm.manualLocation(a)}else if(navigator.geolocation){setTimeout(function(){navigator.geolocation.getCurrentPosition(fshm.locationPageSuccess,fshm.manualLocation,{enableHighAccuracy:true})},500)}else{fshm.manualLocation()}window.setInterval(function(){fshm.foursquareQuery(fshm.currentPosition.lat,fshm.currentPosition.lng)},3e5);n.click(function(){fshm.category=$('input[type="radio"]:checked').val();fshm.foursquareQuery(fshm.currentPosition.lat,fshm.currentPosition.lng)});t.change(function(){fshm.radius=t.val();fshm.foursquareQuery(fshm.currentPosition.lat,fshm.currentPosition.lng)});e.change(function(){if(e.val()){fshm.manualLocation(e.val())}});$("body").on("click","tr",function(){var e=$(this).find(".latlng").text().split(","),t=parseFloat(e[0]).toFixed(3),n=parseFloat(e[1]).toFixed(3),r=0,i,s,o=fshm.infoWindow,u=fshm.venueList;for(r=0;r<u.length;r++){i=u[r].location.lat.toFixed(3);s=u[r].location.lng.toFixed(3);if(t===i&&n===s){var a=fshm.venueInfoOutput(u[r]);o.setContent(a);o.setPosition(new google.maps.LatLng(t,n));o.open(fshm.map)}}})})